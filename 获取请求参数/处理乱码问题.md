---
up:
  - "[[Spring MVC èª²ç¨‹æè¿°]]"
---
> **æ³¨æ„**ï¼šåœ¨ Servlet é˜¶æ®µï¼Œæ˜¯é€šè¿‡`request.setCharacterEncoding("UTF-8");`çš„æ–¹å¼è§£å†³ä¹±ç é—®é¢˜çš„ã€‚è™½ç„¶ SpringMVC ä¸­å¯ä»¥ä½¿ç”¨`HttpServletRequest`å¯¹è±¡ï¼Œä½†æ˜¯æ²¡æœ‰æ•ˆæœã€‚åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œæ˜¯å› ä¸ºè¯·æ±‚å‚æ•°è·å–åœ¨å‰ï¼Œè®¾ç½®ç¼–ç æ ¼å¼åœ¨å

äº‹å®èƒœäºé›„è¾©ï¼Œç®€å•æµ‹è¯•ä¸‹

åå°æµ‹è¯•ä»£ç 

```java
@RequestMapping("/testServletAPI3")
public String testServletAPI3(HttpServletRequest request) throws UnsupportedEncodingException {
    request.setCharacterEncoding("UTF-8");
    String username = request.getParameter("username");
    System.out.println("username=" + username);
    return "success";
}
```

å‰å°æµ‹è¯•ä»£ç 

```html
<form th:action="@{/paramController/testServletAPI3}" method="post">
    ç”¨æˆ·åï¼š<input type="text" name="username"><br/>
    <input type="submit" value="æµ‹è¯•è¯·æ±‚å‚æ•°">
</form>
```

åå°æ—¥å¿—ä¿¡æ¯

```shell
username=Ã¥Â¼Â Ã¤Â¸ï¿½
```

å¯èƒ½ä½ ä¼šè¯´ï¼Œä¸Šé¢çš„æµ‹è¯•éƒ½æ˜¯`post`è¯·æ±‚ï¼Œå¦‚æœæ˜¯`get`è¯·æ±‚å‘¢ï¼Ÿ~~é—®å¾—å¥½ï¼Œä¸‹æ¬¡ä¸è¦é—®äº†~~

```html
<a th:href="@{/paramController/testServletAPI3(username='å¼ ä¸‰')}">é€šè¿‡setCharacterEncodingè®¾ç½®ç¼–ç </a><br/>
```

åå°æ—¥å¿—ä¿¡æ¯

```shell
username=å¼ ä¸‰
```

**Q**ï¼šè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ€ä¹ˆ`get`è¯·æ±‚è¿˜æç‰¹æ®Šï¼Ÿ

**A**ï¼šè¿™æ˜¯å› ä¸º Tomcat çš„ conf ç›®å½•ä¸‹çš„Â `server.xml`ä¸­é…ç½®äº†`URIEncoding="UTF-8"`çš„åŸå› ã€‚è¿™æ ·`get`è¯·æ±‚çš„ä¹±ç é—®é¢˜å°±å¯ä»¥ä¸€æ¬¡æ€§è§£å†³äº†

```xml
<Connector port="8080" protocol="HTTP/1.1" connectionTimeout="20000" redirectPort="8443" URIEncoding="UTF-8"/>
```

å¦‚æœä¸€å¼€å§‹å°±æ²¡æœ‰é…ç½®ï¼Œé‚£`get`è¯·æ±‚ä¹Ÿä¼šä¹±ç ï¼Œæ‰€ä»¥æ‹œæ‰˜ä¸æ˜¯`get`è¯·æ±‚æç‰¹æ®Šäº†å–‚ï¼
 
**Q**ï¼šæ—¢ç„¶åœ¨`server.xml`é…ç½®ä¸‹ç¼–ç æ ¼å¼å°±è¡Œäº†ï¼Œä¸ºä»€ä¹ˆåªæ”¯æŒ`get`è¯·æ±‚å•Šï¼Ÿè¿˜è¯´ä¸æ˜¯æç‰¹æ®Šï¼Ÿ

**A**ï¼š...ä½ èµ¢äº†

**Q**ï¼šé€€ä¸€æ­¥æ¥è¯´ï¼Œ`post`è¯·æ±‚èƒ½ä¸èƒ½åœ¨è¯·æ±‚å‚æ•°è·å–ä¹‹åå†å»å¤„ç†ä¹Ÿå¯ä»¥å§ï¼Œåªè¦çŸ¥é“å…¶æœ¬èº«çš„ç¼–ç 

**A**ï¼šè¯•ä¸€ä¸‹å’¯

æˆ‘ä»¬å…ˆé€šè¿‡Â [åœ¨çº¿ä¹±ç æ¢å¤](http://www.mytju.com/classcode/tools/messycoderecover.asp)Â çœ‹ä¸‹ï¼Œä¹±ç çš„æ–‡æœ¬å®é™…ç¼–ç æ˜¯ä»€ä¹ˆ

![[1755429045113_4hheBBCXqF.png]]

å¾ˆæ˜¾ç„¶ï¼Œä¹±ç æœ¬èº«ä¸º`ISO-8859-1`æ ¼å¼ï¼Œæˆ‘ä»¬è½¬æ¢ä¸º`UTF-8`ç¼–ç æ ¼å¼å³å¯

åå°æµ‹è¯•ä»£ç 

```java
// å¯¹å…¶è¿›è¡Œiso-8859-1è§£ç å¹¶é‡æ–°UTF-8ç¼–ç 
username = new String(username.getBytes("ISO-8859-1"), "UTF-8");
System.out.println("username=" + username);
```

åå°æ—¥å¿—ä¿¡æ¯

```shell
username=å¼ ä¸‰
```

æœ‰ä¸Šè¿°æµ‹è¯•å¯çŸ¥ï¼Œè¦æƒ³å¤„ç†ä¹±ç é—®é¢˜ï¼Œæ€è·¯æœ‰äºŒï¼š

1. è·å–è¯·æ±‚å‚æ•°ä¹‹åï¼Œæ‰‹åŠ¨è§£ç ç¼–ç ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼è¦æ±‚æ¯æ¬¡å¤„ç†`post`è¯·æ±‚çš„è¯·æ±‚å‚æ•°éƒ½è¦æ‰‹åŠ¨å¤„ç†ï¼Œå¤ªä¸äººæ€§åŒ–äº†å§ã€‚~~ä½ å«Œçƒ¦ï¼Œæˆ‘è¿˜å«Œçƒ¦å‘¢~~ï¼ˆâŒï¼‰

2. è·å–è¯·æ±‚å‚æ•°ä¹‹å‰â€œåšæ‰‹è„šâ€ï¼šå‘é€è¯·æ±‚ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯åœ¨`Servlet`å¤„ç†è¯·æ±‚ä¹‹å‰ï¼ˆğŸ‘Œï¼‰

é‚£ä»€ä¹ˆç»„ä»¶æ—¶åœ¨`Servlet`ä¹‹å‰æ‰§è¡Œçš„å‘¢ï¼Ÿ
 
ä¼—æ‰€å‘¨çŸ¥Â ~~ï¼ˆæˆ‘ä¸çŸ¥é“ï¼‰~~ï¼ŒJavaWeb æœåŠ¡å™¨ä¸­ä¸‰å¤§ç»„ä»¶ï¼šç›‘å¬å™¨ã€è¿‡æ»¤å™¨ã€`Servlet`ã€‚å¾ˆæ˜¾ç„¶ï¼Œç›‘å¬å™¨å’Œè¿‡æ»¤å™¨éƒ½åœ¨`Servlet`ä¹‹å‰
 
 - `ServletContextListener`ç›‘å¬å™¨ï¼šåªæ˜¯æ¥ç›‘å¬`ServletContext`çš„åˆ›å»ºå’Œé”€æ¯ï¼Œéƒ½æ˜¯åªæ‰§è¡Œä¸€æ¬¡

 - `Filter`è¿‡æ»¤å™¨ï¼šåªè¦è®¾ç½®äº†è¿‡æ»¤è·¯å¾„ï¼Œåªè¦å½“å‰æ‰€è®¿é—®çš„è¯·æ±‚åœ°å€æ»¡è¶³è¿‡æ»¤è·¯å¾„ï¼Œé‚£ä¹ˆéƒ½ä¼šè¢«è¿‡æ»¤å™¨è¿‡æ»¤ 

å¾ˆæ˜¾ç„¶ï¼Œç”¨è¿‡æ»¤å™¨å°±å¯ä»¥åšåˆ°åœ¨å‘é€è¯·æ±‚ä¹‹å‰â€œåšæ‰‹è„šâ€ï¼Œè¿™æ ·æ‰€æœ‰è¯·æ±‚éƒ½è¦ç»è¿‡è¿‡æ»¤å™¨çš„å¤„ç†ï¼Œå†äº¤ç»™`DispatherServlet`å¤„ç†
 
ä½†æ˜¯ï¼Œè¿™ä¸ªè¿‡æ»¤ä¸éœ€è¦æˆ‘ä»¬å†™ï¼ŒSpringMVC å·²ä¸ºæˆ‘ä»¬å‡†å¤‡å¥½äº†ï¼Œåªè¦å†`web.xml`ä¸­è¿›è¡Œé…ç½®å³å¯

æˆ‘ä»¬å…ˆå¯¹`web.xml`è¿›è¡Œé…ç½®

```xml
<!--å¤„ç†ç¼–ç -->
<filter>
    <filter-name>characterEncodingFilter</filter-name>
    <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
    <init-param>
        <param-name>encoding</param-name>
        <param-value>UTF-8</param-value>
    </init-param>
    <init-param>
        <param-name>forceResponseEncoding</param-name>
        <param-value>true</param-value>
    </init-param>
</filter>
<filter-mapping>
    <filter-name>characterEncodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>
```

é‡å¯åæµ‹è¯•ï¼Œçœ‹ä¸‹åå°æ—¥å¿—ä¿¡æ¯

```shell
username=å¼ ä¸‰
```

Perfect! é…ç½®å¾ˆç®€å•ï¼Œæµ‹è¯•ç»“æœç«‹ç«¿è§å½±ï¼Œä¹±ç é—®é¢˜å¾—åˆ°äº†è§£å†³

> â€œçŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶â€

è¿™ä¸ªç¥å¥‡çš„`CharacterEncodingFilter`åˆ°åº•å¹²äº†ä»€ä¹ˆï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹æºç ä¸€æ¢ç©¶ç«Ÿ

![[1755429045113_aXTW2zT0xd.png]]

æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨`<init-param>`æ ‡ç­¾ä¸­é…ç½®çš„å±æ€§å€¼ï¼Œå…¶å®å°±æ˜¯ä¸ºå¯¹åº”ç±»è¿›è¡Œçš„å±æ€§æ³¨å…¥ã€‚è¿™é‡Œå¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°`encoding`å’Œ`forceResponseEncoding`ä¸¤ä¸ªå±æ€§å€¼ï¼ŒåŒæ—¶æ³¨æ„åˆ°`encoding`è¢«`@Nullable`æ³¨è§£ä¿®é¥°ï¼Œè¡¨ç¤ºå…¶å¯ä»¥ä¸ºç©ºï¼Œ`forceResponseEncoding`é»˜è®¤ä¸º`false`ï¼Œå³ä¸é…ç½®ä¸ç”Ÿæ•ˆ

å¦å¤–ï¼Œçœ‹ä¸€ä¸ª`Filter`æœ€é‡è¦çš„æ‰¾å®ƒçš„`doFilter()`æ–¹æ³•

![[1755429743133_HVS6GobGS4.png]]

å¯ä»¥çœ‹åˆ°ï¼Œ`CharacterEncodingFilter`ç±»ä¸­å¹¶æ²¡æœ‰`doFilter()`æ–¹æ³•ï¼Œé‚£å»å®ƒçš„åŸºç±»ä¸­æ‰¾æ‰¾å§~

![[1755429743140_p4hFei2JLC.png]]

ç›´æ¥è¯»æºç 

```java
@Override
public final void doFilter(ServletRequest request, ServletResponse response, FilterChain filterChain)
    throws ServletException, IOException {
    // å°±æ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯httpè¯·æ±‚å’Œç›¸åº”ï¼Œä¸ç®¡
    if (!(request instanceof HttpServletRequest) || !(response instanceof HttpServletResponse)) {
        throw new ServletException("OncePerRequestFilter just supports HTTP requests");
    }
    // æ‹¿åˆ°ä¸€äº›äº†å¯¹è±¡å’Œå‚æ•°ï¼Œç»§ç»­å¾€ä¸‹çœ‹çœ‹æœ‰ä»€ä¹ˆç”¨å¤„
    HttpServletRequest httpRequest = (HttpServletRequest) request;
    HttpServletResponse httpResponse = (HttpServletResponse) response;
    String alreadyFilteredAttributeName = getAlreadyFilteredAttributeName();
    boolean hasAlreadyFilteredAttribute = request.getAttribute(alreadyFilteredAttributeName) != null;
    // ä¸‰ä¸ªæ¡ä»¶åˆ¤æ–­ï¼Œä¸€ä¸€çœ‹ä¸‹
    // 1ã€è·³è¿‡è½¬å‘æˆ–ä¸è¿‡æ»¤çš„ï¼Œå°±ç›´æ¥è¿›è¡Œè¿‡æ»¤é“¾çš„ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼ˆç¡®ä¿¡ï¼‰
    if (skipDispatch(httpRequest) || shouldNotFilter(httpRequest)) {
        filterChain.doFilter(request, response);
    }
    // 2ã€å·²ç»è¿‡æ»¤å±æ€§çš„ï¼Œå¤šäº†ä¸€å±‚åˆ¤æ–­ï¼Œè²Œä¼¼æ—¶å¤„ç†é”™è¯¯è½¬å‘çš„ï¼Ÿï¼ˆä¸å¤ªæ‡‚ï¼‰
    else if (hasAlreadyFilteredAttribute) {
        if (DispatcherType.ERROR.equals(request.getDispatcherType())) {
            doFilterNestedErrorDispatch(httpRequest, httpResponse, filterChain);
            return;
        }
        filterChain.doFilter(request, response);
    }
    // 3ã€å…¶ä»–æƒ…å†µï¼ˆåº”è¯¥å°±æ˜¯æ­£å¸¸æƒ…å†µå§ï¼‰ï¼šè®¾ç½®ä¸‹å±æ€§ï¼Œå†èµ° doFilterInternal æ–¹æ³•ï¼ˆè¿˜æœ‰å°è±¡å—ï¼Ÿè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åœ¨å…¶å­ç±»CharacterEncodingFilterä¸­çœ‹åˆ°è¿‡çš„ï¼Œé‚£å°±é¡ºè—¤æ‘¸ç“œï¼‰
    else {
        request.setAttribute(alreadyFilteredAttributeName, Boolean.TRUE);
        try {
            doFilterInternal(httpRequest, httpResponse, filterChain);
        }
        finally {
            request.removeAttribute(alreadyFilteredAttributeName);
        }
    }
}
```

å›åˆ°`CharacterEncodingFilter`ä¸­çœ‹ä¸‹`doFilterInternal()`æ–¹æ³•

```java
@Override
protected void doFilterInternal(
    HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
    throws ServletException, IOException {
	// è·å–ç¼–ç æ ¼å¼ï¼Œå¾ˆæ˜æ˜¾å°±æ˜¯è·å–web.xmlä¸­çš„é…ç½®å€¼äº†ï¼ˆç¡®ä¿¡ï¼‰
    String encoding = getEncoding();
    if (encoding != null) {
        // äºŒé€‰ä¸€ï¼šé…ç½®äº†forceRequestEncodingä¸ºtrueæˆ–è€…è¯·æ±‚çš„å­—ç¬¦ç¼–ç æ²¡æœ‰è¢«è®¾ç½®ï¼Œå°±ç»™è¯·æ±‚å¯¹è±¡è®¾ç½®ç¼–ç æ ¼å¼
        if (isForceRequestEncoding() || request.getCharacterEncoding() == null) {
            request.setCharacterEncoding(encoding);
        }
        // é…ç½®äº†forceResponseEncodingä¸ºtrueï¼Œå°±ç»™å“åº”å¯¹è±¡è®¾ç½®ç¼–ç æ ¼å¼
        if (isForceResponseEncoding()) {
            response.setCharacterEncoding(encoding);
        }
    }
    filterChain.doFilter(request, response);
}
```

å¯ä»¥çœ‹å‡º

- æ²¡æœ‰åœ¨`web.xml`è®¾ç½®ç¼–ç æ ¼å¼å°±ä¸ç®¡äº†ï¼Œçˆ±å’‹å’‹åœ°
- è®¾ç½®äº†`encoding`å°±çœ‹ä¸‹æ˜¯è¯·æ±‚å¯¹è±¡è¿˜æ˜¯å“åº”å¯¹è±¡
    - è¯·æ±‚å¯¹è±¡ï¼šå¦‚æœæ‰“å¼€äº†`forceRequestEncoding`å³ _å¼ºåˆ¶è¯·æ±‚ç¼–ç _ å¼€å…³ï¼Œå°±ç»™è®¾ç½®ä¸‹ç¼–ç ï¼›å°±ç®—æ²¡æ‰“å¼€è¿™ä¸ªå¼€å…³ï¼Œåªè¦è¯·æ±‚å¯¹è±¡è¿˜æ²¡æœ‰è®¾ç½®è¿‡å­—ç¬¦ç¼–ç æ ¼å¼ï¼Œé‚£å°±ç»™å®ƒè®¾ç½®ä¸‹
    - å“åº”å¯¹è±¡ï¼šåªæœ‰æ‰“å¼€äº†`forceResponseEncoding`å³ _å¼ºåˆ¶å“åº”ç¼–ç _ å¼€å…³ï¼Œæ‰ç»™è®¾ç½®ç¼–ç 